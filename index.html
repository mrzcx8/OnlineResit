<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resit Generator</title>
    <style>
        /* (CSS sama seperti sebelumnya) */
    </style>
</head>
<body>
    <div class="container">
        <h1>Resit Generator</h1>

        <!-- Input Section -->
        <div class="input-section">
            <!-- (Input fields sama seperti sebelumnya) -->
        </div>

        <!-- Receipt Section -->
        <div class="receipt" id="receipt">
            <!-- (Receipt content sama seperti sebelumnya) -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.24/jspdf.plugin.autotable.min.js"></script>
    <script>
        let items = [];
        let totalAmount = 0;
        let logoFile = null;

        // Fungsi untuk memuat naik logo
        document.getElementById('logo').addEventListener('change', function (event) {
            logoFile = event.target.files[0];
        });

        // Fungsi untuk menambah barang
        function addItem() {
            const itemName = document.getElementById('itemName').value;
            const itemQuantity = parseInt(document.getElementById('itemQuantity').value);
            const itemPrice = parseFloat(document.getElementById('itemPrice').value);

            if (itemName && itemQuantity && itemPrice) {
                const itemTotal = itemQuantity * itemPrice;
                items.push({ itemName, itemQuantity, itemPrice, itemTotal });
                totalAmount += itemTotal;

                // Reset input fields
                document.getElementById('itemName').value = '';
                document.getElementById('itemQuantity').value = '';
                document.getElementById('itemPrice').value = '';

                alert('Barang berjaya ditambah!');
            } else {
                alert('Sila isi semua maklumat barang.');
            }
        }

        // Fungsi untuk menjana resit
        function generateReceipt() {
            const senderName = document.getElementById('senderName').value;
            const senderAddress = document.getElementById('senderAddress').value;
            const senderPhone = document.getElementById('senderPhone').value;
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const tax = parseFloat(document.getElementById('tax').value) || 0;
            const currency = document.getElementById('currency').value;

            if (!senderName || !senderAddress || !senderPhone || !customerName || !customerPhone || items.length === 0) {
                alert('Sila isi semua maklumat pengirim, pelanggan, dan tambah sekurang-kurangnya satu barang.');
                return;
            }

            // Paparkan maklumat pengirim
            const receiptHeader = document.getElementById('receiptHeader');
            receiptHeader.innerHTML = `
                <div style="text-align: center;">
                    ${logoFile ? `<img src="${URL.createObjectURL(logoFile)}" alt="Logo" style="max-width: 100px; margin-bottom: 10px;">` : ''}
                    <h3>${senderName}</h3>
                    <p>${senderAddress}</p>
                    <p>No. Telefon: ${senderPhone}</p>
                </div>
            `;

            // Paparkan maklumat pelanggan
            document.getElementById('displayCustomerName').textContent = customerName;
            document.getElementById('displayCustomerPhone').textContent = customerPhone;

            // Paparkan tarikh
            const currentDate = new Date().toLocaleDateString();
            document.getElementById('receiptDate').textContent = currentDate;

            // Paparkan mata wang
            document.getElementById('currencyDisplay').textContent = currency;

            // Paparkan barang
            const itemsTable = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
            itemsTable.innerHTML = ''; // Kosongkan jadual sebelum menambah barang baru
            items.forEach((item, index) => {
                const row = itemsTable.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.itemName}</td>
                    <td>${item.itemQuantity}</td>
                    <td>${currency} ${item.itemPrice.toFixed(2)}</td>
                    <td>${currency} ${item.itemTotal.toFixed(2)}</td>
                `;
            });

            // Kira jumlah keseluruhan dengan diskaun dan cukai
            const discountedAmount = totalAmount * (1 - discount / 100);
            const taxAmount = discountedAmount * (tax / 100);
            const totalWithTax = discountedAmount + taxAmount;

            // Paparkan diskaun, cukai, dan jumlah keseluruhan
            document.getElementById('displayDiscount').textContent = discount;
            document.getElementById('displayTax').textContent = tax;
            document.getElementById('totalAmount').textContent = totalWithTax.toFixed(2);

            // Tunjukkan resit
            document.getElementById('receipt').style.display = 'block';

            // Auto-nombor resit
            document.getElementById('receiptNumber').textContent = generateReceiptNumber();
        }

        // Fungsi untuk mencetak resit
        function printReceipt() {
            window.print();
        }

        // Fungsi untuk menyimpan resit sebagai PDF
        function saveAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Maklumat pengirim
            const senderName = document.getElementById('senderName').value;
            const senderAddress = document.getElementById('senderAddress').value;
            const senderPhone = document.getElementById('senderPhone').value;

            // Maklumat resit
            const receiptNumber = document.getElementById('receiptNumber').textContent;
            const receiptDate = document.getElementById('receiptDate').textContent;
            const customerName = document.getElementById('displayCustomerName').textContent;
            const customerPhone = document.getElementById('displayCustomerPhone').textContent;
            const currency = document.getElementById('currency').value;
            const discount = document.getElementById('displayDiscount').textContent;
            const tax = document.getElementById('displayTax').textContent;
            const totalAmount = document.getElementById('totalAmount').textContent;

            // Tambahkan logo ke PDF (jika ada)
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function () {
                        doc.addImage(img, 'PNG', 10, 10, 50, 50); // Letakkan logo di bahagian atas
                        doc.setFontSize(12);
                        doc.text(senderName, 70, 20);
                        doc.text(senderAddress, 70, 30);
                        doc.text(`No. Telefon: ${senderPhone}`, 70, 40);

                        // Header resit
                        doc.setFontSize(18);
                        doc.text("Resit Jualan", 10, 70);
                        doc.setFontSize(12);
                        doc.text(`No. Resit: ${receiptNumber}`, 10, 80);
                        doc.text(`Tarikh: ${receiptDate}`, 10, 90);

                        // Maklumat pelanggan
                        doc.setFontSize(14);
                        doc.text("Maklumat Pelanggan", 10, 100);
                        doc.setFontSize(12);
                        doc.text(`Nama: ${customerName}`, 10, 110);
                        doc.text(`No. Telefon: ${customerPhone}`, 10, 120);

                        // Senarai barang dalam bentuk jadual
                        const itemsTable = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
                        const rows = itemsTable.getElementsByTagName('tr');
                        const data = [];
                        for (let i = 0; i < rows.length; i++) {
                            const cols = rows[i].getElementsByTagName('td');
                            data.push([
                                cols[0].textContent, // Bil
                                cols[1].textContent, // Nama Barang
                                cols[2].textContent, // Kuantiti
                                cols[3].textContent, // Harga Seunit
                                cols[4].textContent  // Jumlah
                            ]);
                        }

                        doc.autoTable({
                            startY: 130,
                            head: [['Bil', 'Nama Barang', 'Kuantiti', 'Harga Seunit', 'Jumlah']],
                            body: data,
                            theme: 'grid',
                            styles: { fontSize: 10 },
                            headStyles: { fillColor: [241, 241, 241] }
                        });

                        // Jumlah keseluruhan
                        const finalY = doc.lastAutoTable.finalY + 10;
                        doc.setFontSize(14);
                        doc.text("Jumlah Keseluruhan", 10, finalY);
                        doc.setFontSize(12);
                        doc.text(`Diskaun: ${discount}%`, 10, finalY + 10);
                        doc.text(`Cukai: ${tax}%`, 10, finalY + 20);
                        doc.text(`Jumlah: ${currency} ${totalAmount}`, 10, finalY + 30);

                        // Ucapan terima kasih di tengah bawah
                        doc.setFontSize(12);
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const text = "Terima kasih kerana berurusan dengan kami!";
                        const textWidth = doc.getStringUnitWidth(text) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                        const textX = (pageWidth - textWidth) / 2;
                        doc.text(text, textX, finalY + 50);

                        // Simpan PDF
                        doc.save('resit.pdf');
                    };
                };
                reader.readAsDataURL(logoFile);
            } else {
                // Jika tiada logo, teruskan tanpa logo
                doc.setFontSize(12);
                doc.text(senderName, 10, 20);
                doc.text(senderAddress, 10, 30);
                doc.text(`No. Telefon: ${senderPhone}`, 10, 40);

                // Header resit
                doc.setFontSize(18);
                doc.text("Resit Jualan", 10, 50);
                doc.setFontSize(12);
                doc.text(`No. Resit: ${receiptNumber}`, 10, 60);
                doc.text(`Tarikh: ${receiptDate}`, 10, 70);

                // Maklumat pelanggan
                doc.setFontSize(14);
                doc.text("Maklumat Pelanggan", 10, 80);
                doc.setFontSize(12);
                doc.text(`Nama: ${customerName}`, 10, 90);
                doc.text(`No. Telefon: ${customerPhone}`, 10, 100);

                // Senarai barang dalam bentuk jadual
                const itemsTable = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
                const rows = itemsTable.getElementsByTagName('tr');
                const data = [];
                for (let i = 0; i < rows.length; i++) {
                    const cols = rows[i].getElementsByTagName('td');
                    data.push([
                        cols[0].textContent, // Bil
                        cols[1].textContent, // Nama Barang
                        cols[2].textContent, // Kuantiti
                        cols[3].textContent, // Harga Seunit
                        cols[4].textContent  // Jumlah
                    ]);
                }

                doc.autoTable({
                    startY: 110,
                    head: [['Bil', 'Nama Barang', 'Kuantiti', 'Harga Seunit', 'Jumlah']],
                    body: data,
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [241, 241, 241] }
                });

                // Jumlah keseluruhan
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(14);
                doc.text("Jumlah Keseluruhan", 10, finalY);
                doc.setFontSize(12);
                doc.text(`Diskaun: ${discount}%`, 10, finalY + 10);
                doc.text(`Cukai: ${tax}%`, 10, finalY + 20);
                doc.text(`Jumlah: ${currency} ${totalAmount}`, 10, finalY + 30);

                // Ucapan terima kasih di tengah bawah
                doc.setFontSize(12);
                const pageWidth = doc.internal.pageSize.getWidth();
                const text = "Terima kasih kerana berurusan dengan kami!";
                const textWidth = doc.getStringUnitWidth(text) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                const textX = (pageWidth - textWidth) / 2;
                doc.text(text, textX, finalY + 50);

                // Simpan PDF
                doc.save('resit.pdf');
            }
        }

        // Fungsi untuk auto-nombor resit
        function generateReceiptNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `RESIT-${year}${month}${day}-${hours}${minutes}${seconds}`;
        }
    </script>
</body>
</html>
